# File: release-win.yml
# Code: Claude Code
# Review: Ryoichi Ando (ryoichi.ando@zozo.com)
# License: Apache v2.0

name: Build Windows

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build only, no release)'
        required: true
        type: boolean
        default: true

jobs:
  release-windows:
    name: Build and Release Windows Bundle
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      AWS_REGION: us-east-2
      INSTANCE_TYPE: g6e.2xlarge
      WORKDIR: C:\ppf-contact-solver
      USER: Administrator

    steps:
      - name: Get version and mode
        id: version
        run: |
          VERSION="$(TZ='Asia/Tokyo' date '+%Y-%m-%d-%H-%M')"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "DRY_RUN=$DRY_RUN" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Dry run: $DRY_RUN"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS authentication
        run: |
          echo "Testing AWS authentication..."
          aws sts get-caller-identity
          echo "AWS Region: $AWS_REGION"
          echo "Instance Type: $INSTANCE_TYPE"
          echo "Version: ${{ steps.version.outputs.VERSION }}"

      - name: Find Windows Server 2025 AMI
        id: ami
        run: |
          echo "Finding latest Windows Server 2025 AMI..."
          AMI_ID=$(aws ec2 describe-images \
            --owners amazon \
            --filters \
              "Name=name,Values=Windows_Server-2025-English-Full-Base-*" \
              "Name=state,Values=available" \
            --query 'sort_by(Images, &CreationDate)[-1].ImageId' \
            --region "$AWS_REGION" \
            --output text)
          if [ "$AMI_ID" = "None" ] || [ -z "$AMI_ID" ]; then
            echo "ERROR: Windows Server 2025 AMI not found in region $AWS_REGION"
            exit 1
          fi
          echo "AMI_ID=$AMI_ID" >> $GITHUB_OUTPUT
          echo "Found AMI: $AMI_ID"

      - name: Get github-actions-vpc subnet and security group
        id: vpc
        run: |
          echo "Getting github-actions-vpc..."
          VPC_ID=$(aws ec2 describe-vpcs \
            --filters "Name=tag:Name,Values=github-actions-vpc" \
            --query 'Vpcs[0].VpcId' \
            --region "$AWS_REGION" \
            --output text)
          if [ "$VPC_ID" = "None" ] || [ -z "$VPC_ID" ]; then
            echo "ERROR: github-actions-vpc not found in region $AWS_REGION"
            exit 1
          fi
          echo "::add-mask::$VPC_ID"
          echo "VPC: $VPC_ID"

          echo "Getting subnet in github-actions-vpc..."
          SUBNET_ID=$(aws ec2 describe-subnets \
            --filters "Name=vpc-id,Values=$VPC_ID" \
            --query 'Subnets[0].SubnetId' \
            --region "$AWS_REGION" \
            --output text)
          if [ "$SUBNET_ID" = "None" ] || [ -z "$SUBNET_ID" ]; then
            echo "ERROR: No subnet found in github-actions-vpc"
            exit 1
          fi
          echo "::add-mask::$SUBNET_ID"
          echo "SUBNET_ID=$SUBNET_ID" >> $GITHUB_OUTPUT
          echo "Subnet: $SUBNET_ID"

          echo "Getting github-actions-sg security group..."
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=vpc-id,Values=$VPC_ID" "Name=group-name,Values=github-actions-sg" \
            --query 'SecurityGroups[0].GroupId' \
            --region "$AWS_REGION" \
            --output text)
          if [ "$SG_ID" = "None" ] || [ -z "$SG_ID" ]; then
            echo "ERROR: github-actions-sg not found in github-actions-vpc"
            exit 1
          fi
          echo "::add-mask::$SG_ID"
          echo "SG_ID=$SG_ID" >> $GITHUB_OUTPUT
          echo "Security Group: $SG_ID"

          echo "Getting EC2 Instance Connect Endpoint..."
          EICE_ID=$(aws ec2 describe-instance-connect-endpoints \
            --filters "Name=state,Values=create-complete" \
            --query 'InstanceConnectEndpoints[0].InstanceConnectEndpointId' \
            --region "$AWS_REGION" \
            --output text)
          if [ "$EICE_ID" = "None" ] || [ -z "$EICE_ID" ]; then
            echo "ERROR: EC2 Instance Connect Endpoint not found in region $AWS_REGION"
            exit 1
          fi
          echo "::add-mask::$EICE_ID"
          echo "EICE_ID=$EICE_ID" >> $GITHUB_OUTPUT
          echo "EICE: $EICE_ID"

      - name: Generate unique identifiers
        id: ids
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          RANDOM_SUFFIX=$(head /dev/urandom | tr -dc a-z0-9 | head -c 6)
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "RANDOM_SUFFIX=$RANDOM_SUFFIX" >> $GITHUB_OUTPUT
          echo "Timestamp: $TIMESTAMP"

      - name: Create key pair for build instance
        id: keypair
        run: |
          KEY_NAME="win-release-build-${{ steps.ids.outputs.TIMESTAMP }}"
          echo "::add-mask::$KEY_NAME"
          echo "KEY_NAME=$KEY_NAME" >> $GITHUB_OUTPUT
          aws ec2 create-key-pair \
            --key-name "$KEY_NAME" \
            --query 'KeyMaterial' \
            --region "$AWS_REGION" \
            --output text > /tmp/ec2key
          chmod 600 /tmp/ec2key
          echo "Created key pair: $KEY_NAME"

      - name: Create Windows user data script
        run: |
          # Use standard SSH port 22 since we're using EICE tunnels
          sed "s/SSH_PORT_PLACEHOLDER/22/g" .github/workflows/scripts/win/user-data.ps1 > /tmp/user-data.ps1
          echo "User data script created with SSH port 22"

      - name: Launch EC2 instance
        id: instance
        run: |
          echo "Launching Windows EC2 instance..."
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id "${{ steps.ami.outputs.AMI_ID }}" \
            --instance-type "$INSTANCE_TYPE" \
            --key-name "${{ steps.keypair.outputs.KEY_NAME }}" \
            --subnet-id "${{ steps.vpc.outputs.SUBNET_ID }}" \
            --security-group-ids "${{ steps.vpc.outputs.SG_ID }}" \
            --associate-public-ip-address \
            --user-data file:///tmp/user-data.ps1 \
            --block-device-mappings "DeviceName=/dev/sda1,Ebs={VolumeSize=100,VolumeType=gp3,DeleteOnTermination=true}" \
            --tag-specifications \
              "ResourceType=instance,Tags=[{Key=Name,Value=gpu-runner-win-release-${{ steps.version.outputs.VERSION }}-${{ steps.ids.outputs.TIMESTAMP }}},{Key=ManagedBy,Value=GitHubActions},{Key=Purpose,Value=WindowsReleaseBuild},{Key=Workflow,Value=${{ github.workflow }}},{Key=RunId,Value=${{ github.run_id }}},{Key=Version,Value=${{ steps.version.outputs.VERSION }}}]" \
              "ResourceType=volume,Tags=[{Key=Name,Value=gpu-runner-win-release-${{ steps.version.outputs.VERSION }}-${{ steps.ids.outputs.TIMESTAMP }}-volume},{Key=ManagedBy,Value=GitHubActions},{Key=Purpose,Value=WindowsReleaseBuild}]" \
            --instance-initiated-shutdown-behavior terminate \
            --query 'Instances[0].InstanceId' \
            --region "$AWS_REGION" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Instance launched: $INSTANCE_ID"

      - name: Wait for instance to be running
        run: |
          echo "Waiting for instance to be running..."
          aws ec2 wait instance-running \
            --instance-ids "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --region "$AWS_REGION"
          echo "Instance is running"

      - name: Wait for SSH via EICE tunnel
        run: |
          echo "Waiting for SSH to be ready via EICE tunnel..."
          MAX_SSH_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_SSH_ATTEMPTS ]; do
            # Start EICE tunnel
            aws ec2-instance-connect open-tunnel \
              --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
              --local-port 2222 \
              --region "$AWS_REGION" &
            TUNNEL_PID=$!
            sleep 3

            if ssh -p 2222 -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -o BatchMode=yes -i /tmp/ec2key Administrator@localhost "echo SSH_READY" 2>/dev/null | grep -q SSH_READY; then
              echo "SSH connection established!"
              kill $TUNNEL_PID 2>/dev/null || true
              break
            fi
            kill $TUNNEL_PID 2>/dev/null || true
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -eq $MAX_SSH_ATTEMPTS ]; then
              echo "Failed to establish SSH connection"
              exit 1
            fi
            echo "SSH not ready (attempt $ATTEMPT/$MAX_SSH_ATTEMPTS), waiting 30s..."
            sleep 30
          done

          echo "Waiting for SSH setup completion..."
          MAX_SETUP_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_SETUP_ATTEMPTS ]; do
            aws ec2-instance-connect open-tunnel \
              --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
              --local-port 2222 \
              --region "$AWS_REGION" &
            TUNNEL_PID=$!
            sleep 3

            if ssh -p 2222 -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -i /tmp/ec2key Administrator@localhost \
              "if (Test-Path C:\\ssh_ready.txt) { echo READY } else { echo NOT_READY }" 2>/dev/null | grep -q READY; then
              echo "SSH setup complete!"
              kill $TUNNEL_PID 2>/dev/null || true
              break
            fi
            kill $TUNNEL_PID 2>/dev/null || true
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -eq $MAX_SETUP_ATTEMPTS ]; then
              echo "SSH setup timed out, continuing anyway..."
              break
            fi
            echo "SSH setup not complete (attempt $ATTEMPT/$MAX_SETUP_ATTEMPTS), waiting 30s..."
            sleep 30
          done

      - name: Install NVIDIA driver only (no CUDA toolkit)
        run: |
          echo "Installing NVIDIA driver (this will take a few minutes)..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/ec2key .github/workflows/scripts/win/install-nvidia-driver.ps1 Administrator@localhost:C:/install_driver.ps1
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "powershell -ExecutionPolicy Bypass -File C:/install_driver.ps1"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Create archive of repository
        run: |
          echo "Creating repository archive..."
          git archive --format=zip --output=/tmp/repo.zip HEAD

      - name: Transfer repository to instance
        run: |
          echo "Transferring repository to instance..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/ec2key /tmp/repo.zip Administrator@localhost:C:/source.zip
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/ec2key Administrator@localhost \
            "powershell -Command \"if (Test-Path 'C:\\ppf-contact-solver') { Remove-Item -Recurse -Force 'C:\\ppf-contact-solver' }; New-Item -ItemType Directory -Path 'C:\\ppf-contact-solver' -Force; Expand-Archive -Path 'C:\\source.zip' -DestinationPath 'C:\\ppf-contact-solver' -Force; Remove-Item 'C:\\source.zip'\""
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Run warmup.bat
        run: |
          echo "Running warmup.bat..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "cmd /c 'cd C:\\ppf-contact-solver\\build-win-native && warmup.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Run build.bat
        run: |
          echo "Running build.bat..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "cmd /c 'cd C:\\ppf-contact-solver\\build-win-native && build.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Run bundle.bat
        run: |
          echo "Running bundle.bat..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "cmd /c 'cd C:\\ppf-contact-solver\\build-win-native && bundle.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Test bundle with headless.bat
        run: |
          echo "Testing bundle with headless.bat..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "cmd /c 'cd C:\\ppf-contact-solver\\build-win-native\\dist && headless.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Run fast-check-all.bat on bundle
        run: |
          echo "Running fast-check-all.bat on bundle..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "cmd /c 'cd C:\\ppf-contact-solver\\build-win-native\\dist && fast-check-all.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Download build test log
        if: always()
        continue-on-error: true
        run: |
          echo "Downloading test results log from build instance..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/ec2key "Administrator@localhost:C:/ppf-contact-solver/build-win-native/dist/fast-check-results.log" \
            ./build-fast-check-results.log 2>/dev/null || echo "Log file not found"
          kill $TUNNEL_PID 2>/dev/null || true
          if [ -f ./build-fast-check-results.log ]; then
            echo "=== Build Instance Test Results ==="
            cat ./build-fast-check-results.log
          fi

      - name: Clean up test artifacts
        run: |
          echo "Cleaning up test artifacts..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/ec2key Administrator@localhost \
            "powershell -Command \"Remove-Item -Recurse -Force 'C:\\ppf-contact-solver\\build-win-native\\dist\\local' -ErrorAction SilentlyContinue; Remove-Item -Recurse -Force 'C:\\ppf-contact-solver\\build-win-native\\dist\\cache' -ErrorAction SilentlyContinue; Remove-Item -Recurse -Force 'C:\\ppf-contact-solver\\build-win-native\\dist\\export' -ErrorAction SilentlyContinue; Get-ChildItem -Path 'C:\\ppf-contact-solver\\build-win-native\\dist' -Recurse -Directory -Filter '__pycache__' | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue; Get-ChildItem -Path 'C:\\ppf-contact-solver\\build-win-native\\dist' -Recurse -Include '*.pyc','*.pyo' | Remove-Item -Force -ErrorAction SilentlyContinue\""
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Create release archive
        run: |
          echo "Creating release archive..."
          VERSION="${{ steps.version.outputs.VERSION }}"
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/ec2key Administrator@localhost \
            "powershell -Command \"Compress-Archive -Path 'C:\\ppf-contact-solver\\build-win-native\\dist\\*' -DestinationPath 'C:\\ppf-contact-solver-${VERSION}-win64.zip' -Force\""
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Download release archive
        run: |
          echo "Downloading release archive..."
          VERSION="${{ steps.version.outputs.VERSION }}"
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --local-port 2222 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2222 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/ec2key "Administrator@localhost:C:/ppf-contact-solver-${VERSION}-win64.zip" ./
          kill $TUNNEL_PID 2>/dev/null || true
          ls -lh "ppf-contact-solver-${VERSION}-win64.zip"

      # ============================================================
      # PHASE 2: Clean Environment Verification
      # Launch a second Windows instance with only NVIDIA driver
      # to verify the bundle has no external DLL dependencies
      # ============================================================

      - name: Re-authenticate for build instance cleanup
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terminate build instance
        run: |
          echo "Terminating build instance: ${{ steps.instance.outputs.INSTANCE_ID }}"
          aws ec2 terminate-instances \
            --instance-ids "${{ steps.instance.outputs.INSTANCE_ID }}" \
            --region "$AWS_REGION"
          echo "Build instance termination requested"

      - name: Delete build instance key pair
        run: |
          echo "Deleting build instance key pair: ${{ steps.keypair.outputs.KEY_NAME }}"
          aws ec2 delete-key-pair --key-name "${{ steps.keypair.outputs.KEY_NAME }}" --region "$AWS_REGION" || true

      - name: Generate verification instance identifiers
        id: verify-ids
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          RANDOM_SUFFIX=$(head /dev/urandom | tr -dc a-z0-9 | head -c 6)
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "RANDOM_SUFFIX=$RANDOM_SUFFIX" >> $GITHUB_OUTPUT
          echo "Verification Timestamp: $TIMESTAMP"

      - name: Create key pair for verification instance
        id: verify-keypair
        run: |
          KEY_NAME="win-release-verify-${{ steps.verify-ids.outputs.TIMESTAMP }}"
          echo "::add-mask::$KEY_NAME"
          echo "KEY_NAME=$KEY_NAME" >> $GITHUB_OUTPUT
          aws ec2 create-key-pair \
            --key-name "$KEY_NAME" \
            --query 'KeyMaterial' \
            --region "$AWS_REGION" \
            --output text > /tmp/verify-ec2key
          chmod 600 /tmp/verify-ec2key
          echo "Created verification key pair: $KEY_NAME"

      - name: Launch verification instance
        id: verify-instance
        run: |
          echo "Launching verification Windows instance (minimal setup - driver only)..."
          # Use standard SSH port 22 since we're using EICE tunnels
          sed "s/SSH_PORT_PLACEHOLDER/22/g" .github/workflows/scripts/win/user-data.ps1 > /tmp/verify-user-data.ps1

          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id "${{ steps.ami.outputs.AMI_ID }}" \
            --instance-type "$INSTANCE_TYPE" \
            --key-name "${{ steps.verify-keypair.outputs.KEY_NAME }}" \
            --subnet-id "${{ steps.vpc.outputs.SUBNET_ID }}" \
            --security-group-ids "${{ steps.vpc.outputs.SG_ID }}" \
            --associate-public-ip-address \
            --user-data file:///tmp/verify-user-data.ps1 \
            --block-device-mappings "DeviceName=/dev/sda1,Ebs={VolumeSize=100,VolumeType=gp3,DeleteOnTermination=true}" \
            --tag-specifications \
              "ResourceType=instance,Tags=[{Key=Name,Value=gpu-runner-win-verify-${{ steps.version.outputs.VERSION }}-${{ steps.verify-ids.outputs.TIMESTAMP }}},{Key=ManagedBy,Value=GitHubActions},{Key=Purpose,Value=WindowsBundleVerification},{Key=Workflow,Value=${{ github.workflow }}},{Key=RunId,Value=${{ github.run_id }}},{Key=Version,Value=${{ steps.version.outputs.VERSION }}}]" \
              "ResourceType=volume,Tags=[{Key=Name,Value=gpu-runner-win-verify-${{ steps.version.outputs.VERSION }}-${{ steps.verify-ids.outputs.TIMESTAMP }}-volume},{Key=ManagedBy,Value=GitHubActions},{Key=Purpose,Value=WindowsBundleVerification}]" \
            --instance-initiated-shutdown-behavior terminate \
            --query 'Instances[0].InstanceId' \
            --region "$AWS_REGION" \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "Verification instance launched: $INSTANCE_ID"

      - name: Wait for verification instance to be running
        run: |
          echo "Waiting for verification instance to be running..."
          aws ec2 wait instance-running \
            --instance-ids "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --region "$AWS_REGION"
          echo "Verification instance is running"

      - name: Wait for verification instance SSH via EICE tunnel
        run: |
          echo "Waiting for SSH to be ready on verification instance..."
          MAX_SSH_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_SSH_ATTEMPTS ]; do
            aws ec2-instance-connect open-tunnel \
              --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
              --local-port 2223 \
              --region "$AWS_REGION" &
            TUNNEL_PID=$!
            sleep 3

            if ssh -p 2223 -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -o BatchMode=yes -i /tmp/verify-ec2key Administrator@localhost "echo SSH_READY" 2>/dev/null | grep -q SSH_READY; then
              echo "SSH connection established!"
              kill $TUNNEL_PID 2>/dev/null || true
              break
            fi
            kill $TUNNEL_PID 2>/dev/null || true
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -eq $MAX_SSH_ATTEMPTS ]; then
              echo "Failed to establish SSH connection"
              exit 1
            fi
            echo "SSH not ready (attempt $ATTEMPT/$MAX_SSH_ATTEMPTS), waiting 30s..."
            sleep 30
          done

          echo "Waiting for SSH setup completion..."
          MAX_SETUP_ATTEMPTS=30
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_SETUP_ATTEMPTS ]; do
            aws ec2-instance-connect open-tunnel \
              --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
              --local-port 2223 \
              --region "$AWS_REGION" &
            TUNNEL_PID=$!
            sleep 3

            if ssh -p 2223 -o ConnectTimeout=10 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
              -i /tmp/verify-ec2key Administrator@localhost \
              "if (Test-Path C:\\ssh_ready.txt) { echo READY } else { echo NOT_READY }" 2>/dev/null | grep -q READY; then
              echo "SSH setup complete!"
              kill $TUNNEL_PID 2>/dev/null || true
              break
            fi
            kill $TUNNEL_PID 2>/dev/null || true
            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -eq $MAX_SETUP_ATTEMPTS ]; then
              echo "SSH setup timed out, continuing anyway..."
              break
            fi
            echo "SSH setup not complete (attempt $ATTEMPT/$MAX_SETUP_ATTEMPTS), waiting 30s..."
            sleep 30
          done

      - name: Install NVIDIA driver on verification instance
        run: |
          echo "Installing NVIDIA driver only (this will take a few minutes)..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --local-port 2223 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/verify-ec2key .github/workflows/scripts/win/install-nvidia-driver.ps1 Administrator@localhost:C:/install_driver.ps1
          ssh -p 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/verify-ec2key Administrator@localhost \
            "powershell -ExecutionPolicy Bypass -File C:/install_driver.ps1"
          kill $TUNNEL_PID 2>/dev/null || true

      - name: Transfer bundle to verification instance
        run: |
          echo "Transferring bundle to verification instance..."
          VERSION="${{ steps.version.outputs.VERSION }}"
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --local-port 2223 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/verify-ec2key "ppf-contact-solver-${VERSION}-win64.zip" Administrator@localhost:C:/bundle.zip
          kill $TUNNEL_PID 2>/dev/null || true
          echo "Bundle transferred successfully"

      - name: Extract and verify bundle
        run: |
          echo "Extracting bundle on verification instance..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --local-port 2223 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/verify-ec2key Administrator@localhost \
            "powershell -Command \"if (Test-Path 'C:\\bundle') { Remove-Item -Recurse -Force 'C:\\bundle' }; New-Item -ItemType Directory -Path 'C:\\bundle' -Force; Expand-Archive -Path 'C:\\bundle.zip' -DestinationPath 'C:\\bundle' -Force\""
          kill $TUNNEL_PID 2>/dev/null || true
          echo "Bundle extracted successfully"

      - name: Run headless.bat on clean environment
        run: |
          echo "Running headless.bat on clean environment (no CUDA toolkit, no build tools)..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --local-port 2223 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/verify-ec2key Administrator@localhost \
            "cmd /c 'cd C:\\bundle && headless.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true
          echo "Bundle verification PASSED - no external DLL dependencies detected"

      - name: Run fast-check-all.bat on clean environment
        run: |
          echo "Running fast-check-all.bat on clean environment..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --local-port 2223 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          ssh -p 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=60 -o ServerAliveCountMax=10 -i /tmp/verify-ec2key Administrator@localhost \
            "cmd /c 'cd C:\\bundle && fast-check-all.bat /nopause'"
          kill $TUNNEL_PID 2>/dev/null || true
          echo "All example notebooks PASSED on clean environment"

      - name: Download verification test log
        if: always()
        continue-on-error: true
        run: |
          echo "Downloading test results log from verification instance..."
          aws ec2-instance-connect open-tunnel \
            --instance-id "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --local-port 2223 \
            --region "$AWS_REGION" &
          TUNNEL_PID=$!
          sleep 3
          scp -P 2223 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/verify-ec2key "Administrator@localhost:C:/bundle/fast-check-results.log" \
            ./verify-fast-check-results.log 2>/dev/null || echo "Log file not found"
          kill $TUNNEL_PID 2>/dev/null || true
          if [ -f ./verify-fast-check-results.log ]; then
            echo "=== Verification Instance Test Results ==="
            cat ./verify-fast-check-results.log
          fi

      - name: Terminate verification instance
        run: |
          echo "Terminating verification instance: ${{ steps.verify-instance.outputs.INSTANCE_ID }}"
          aws ec2 terminate-instances \
            --instance-ids "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
            --region "$AWS_REGION"
          echo "Verification instance termination initiated"

      - name: Delete verification instance key pair
        run: |
          echo "Deleting verification instance key pair: ${{ steps.verify-keypair.outputs.KEY_NAME }}"
          aws ec2 delete-key-pair --key-name "${{ steps.verify-keypair.outputs.KEY_NAME }}" --region "$AWS_REGION" || true

      # ============================================================
      # PHASE 3: Release (if not dry run)
      # ============================================================

      - name: Create version tag
        if: steps.version.outputs.DRY_RUN != 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Creating tag $VERSION..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Create GitHub Release
        if: steps.version.outputs.DRY_RUN != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Creating GitHub Release for $VERSION..."
          gh release create "$VERSION" \
            --title "ZOZO's Contact Solver $VERSION" \
            --generate-notes \
            "ppf-contact-solver-${VERSION}-win64.zip#Windows Bundle (win64)"

      - name: Extract archive for artifact (dry run)
        if: steps.version.outputs.DRY_RUN == 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p artifact-contents
          # Capture exit code without triggering errexit (set -e)
          UNZIP_EXIT=0
          unzip "ppf-contact-solver-${VERSION}-win64.zip" -d artifact-contents || UNZIP_EXIT=$?
          if [ $UNZIP_EXIT -gt 1 ]; then
            echo "unzip failed with exit code $UNZIP_EXIT"
            exit 1
          fi
          echo "unzip completed with exit code $UNZIP_EXIT"
          # Fix permissions for upload (Windows zip may have restrictive perms)
          chmod -R u+rwX artifact-contents/
          # Verify key files exist
          if [ ! -f "artifact-contents/target/release/ppf-contact-solver.exe" ]; then
            echo "ERROR: ppf-contact-solver.exe not found in archive"
            exit 1
          fi
          if [ ! -f "artifact-contents/headless.bat" ]; then
            echo "ERROR: headless.bat not found in archive"
            exit 1
          fi
          echo "Archive extracted successfully"

      - name: Upload artifact (dry run)
        if: steps.version.outputs.DRY_RUN == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.version.outputs.VERSION }}
          path: artifact-contents/
          retention-days: 7

      - name: Dry run summary
        if: steps.version.outputs.DRY_RUN == 'true'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "## DRY RUN COMPLETE"
          echo "Build and verification succeeded. No release was created."
          echo ""
          echo "Verification: Bundle tested on clean Windows instance with only NVIDIA driver"
          echo "              (no CUDA toolkit, no build tools, no Chocolatey, no Git)"
          echo ""
          echo "Archive uploaded as artifact: ppf-contact-solver-${VERSION}-win64"
          ls -lh "ppf-contact-solver-${VERSION}-win64.zip"

      - name: Re-authenticate for cleanup
        if: always()
        continue-on-error: true
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Cleanup - Terminate Instances
        if: always()
        continue-on-error: true
        run: |
          # Terminate build instance if known
          if [ -n "${{ steps.instance.outputs.INSTANCE_ID }}" ]; then
            echo "Terminating build instance: ${{ steps.instance.outputs.INSTANCE_ID }}"
            aws ec2 terminate-instances \
              --instance-ids "${{ steps.instance.outputs.INSTANCE_ID }}" \
              --region "$AWS_REGION" || true
          fi
          # Terminate verification instance if known
          if [ -n "${{ steps.verify-instance.outputs.INSTANCE_ID }}" ]; then
            echo "Terminating verification instance: ${{ steps.verify-instance.outputs.INSTANCE_ID }}"
            aws ec2 terminate-instances \
              --instance-ids "${{ steps.verify-instance.outputs.INSTANCE_ID }}" \
              --region "$AWS_REGION" || true
          fi
          # Fallback: Find and terminate any instances tagged with this run ID
          # This catches instances launched but not captured in step outputs (e.g., on cancellation)
          echo "Searching for any orphaned instances from this run..."
          ORPHANED_INSTANCES=$(aws ec2 describe-instances \
            --filters \
              "Name=tag:RunId,Values=${{ github.run_id }}" \
              "Name=instance-state-name,Values=pending,running,stopping,stopped" \
            --query 'Reservations[].Instances[].InstanceId' \
            --region "$AWS_REGION" \
            --output text || echo "")
          if [ -n "$ORPHANED_INSTANCES" ]; then
            echo "Found orphaned instances: $ORPHANED_INSTANCES"
            aws ec2 terminate-instances \
              --instance-ids $ORPHANED_INSTANCES \
              --region "$AWS_REGION" || true
          else
            echo "No orphaned instances found"
          fi

      - name: Cleanup - Delete Key Pairs
        if: always()
        continue-on-error: true
        run: |
          # Delete build instance key pair
          if [ -n "${{ steps.keypair.outputs.KEY_NAME }}" ]; then
            echo "Deleting build key pair: ${{ steps.keypair.outputs.KEY_NAME }}"
            aws ec2 delete-key-pair --key-name "${{ steps.keypair.outputs.KEY_NAME }}" --region "$AWS_REGION" || true
          fi
          # Delete verification instance key pair
          if [ -n "${{ steps.verify-keypair.outputs.KEY_NAME }}" ]; then
            echo "Deleting verification key pair: ${{ steps.verify-keypair.outputs.KEY_NAME }}"
            aws ec2 delete-key-pair --key-name "${{ steps.verify-keypair.outputs.KEY_NAME }}" --region "$AWS_REGION" || true
          fi

      - name: Cleanup - Remove Local SSH Keys
        if: always()
        continue-on-error: true
        run: |
          rm -f /tmp/ec2key /tmp/verify-ec2key

      - name: Summary
        if: always()
        run: |
          echo "## Release Build Summary"
          echo "- Version: ${{ steps.version.outputs.VERSION }}"
          echo "- Region: $AWS_REGION"
          echo "- Instance Type: $INSTANCE_TYPE"
          echo "- Build Instance ID: ${{ steps.instance.outputs.INSTANCE_ID || 'Not launched' }}"
          echo "- Verification Instance ID: ${{ steps.verify-instance.outputs.INSTANCE_ID || 'Not launched' }}"
          echo ""
          echo "## Workflow Phases"
          echo "1. Build Phase: Compiled on instance with CUDA 12.8 and build tools"
          echo "2. Verification Phase: Tested on clean instance with only NVIDIA driver"
          echo "3. Release Phase: Created GitHub release (if not dry run)"
